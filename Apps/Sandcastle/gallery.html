<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Sandcastle Gallery</title>

    <link rel="stylesheet" href="../../ThirdParty/bootstrap-3.3.2/css/bootstrap.min.css">
    <!-- <link rel="stylesheet" href="css/main.css"> -->
    <style>
        .col-sm-3{
            min-height: 345px;
        }

        .tab-pane{
            padding-top: 20px;
        }
    </style>
</head>
<body>
<!--[if lt IE 11]>
<p class="browserupgrade">You are using an <strong>outdated</strong> browser that does not support WebGL.
    Please <a href="http://browsehappy.com/">upgrade your browser</a> to use Cesium Sandcastle.</p>
<![endif]-->

<nav class="navbar navbar-default" id="toolbar">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#toolbar-extend">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://cesiumjs.org/" target="_blank"><img src="./img/Cesium_Logo_Color_Overlay.png" style="width: 118px"/></a>
    </div>


    <div class="collapse navbar-collapse" id="toolbar-extend">
      <ul class="nav navbar-nav">
          <li id="buttonNew"><a href="index.html">New</a></li>
      </ul>
      <form class="navbar-form navbar-right" role="search">
          <div class="form-group">
              <input type="text" id="searchBox" class="form-control" placeholder="Search">
          </div>
      </form>
    </div>
  </div>
</nav>

<div id="bodyContainer" class="container-fluid">
    <div id="bodyRow" class="row">
        <div id="gallery-tabs" class="col-sm-12">
            <div role="tabpanel">
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#all" aria-controls="all" role="tab" data-toggle="tab">All</a></li>
                    <li role="presentation"><a style="display:none" href="#search" aria-controls="search" role="tab" data-toggle="tab">Search Result</a></li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content">

                    <div role="tabpanel" class="tab-pane active" id="all">
                        <div class="row">
                            
                        </div>
                    </div>

                    <div role="tabpanel" class="tab-pane" id="search">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="error-msg alert alert-danger" role="alert">
                                    <span>No demos match your search term</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script src="gallery/gallery-index.js"></script>
<script src="js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
<script src="../../ThirdParty/jquery/dist/jquery.min.js"></script>
<script src="../../ThirdParty/bootstrap-3.3.2/js/bootstrap.min.js"></script>
<script type="text/javascript">

    var tabHeader = '<li role="presentation"><a href="{{tablink}}" aria-controls="{{tabname}}" role="tab" data-toggle="tab">{{tabheading}}</a></li>';
    var tabPanel = '<div role="tabpanel" class="tab-pane" id="{{tabname}}"><div class="row"></div></div>';
    var demoEle = '<div class="col-sm-3"><div class="thumbnail" id="{demo}"><a href="index.html?src={href}"><img src="img/gallery/{image}.jpg" alt="Demo Thumbnail"><div class="caption"><h5>{title}</h5><p class="hidden-xs">{description}</p></div></a></div></div>';
    var galleryList = [];
    var scriptCodeRegex = /\/\/Sandcastle_Begin\s*([\s\S]*)\/\/Sandcastle_End/;

    for(var j = 0; j< gallery_demos.length; j++){
        var development = false;
        var demoData = gallery_demos[j];
        var demoName = demoData.name;
        var label = demoData.labels;
        var desc = demoData.description;
        var id = demoData.id;
        requestCode(demoName, id);
        var labels = label.split(',');
        var imgName = demoName.substring(demoName.indexOf('/')+1);
        var ele  = demoEle.replace('{image}', imgName);
        ele = ele.replace('{title}', demoName).replace('{description}',desc).replace('{href}', encodeURIComponent(demoName)).replace('{demo}',demoName.replace(/\s+/g,'').replace(/\)/g,'').replace(/\(/g,'').replace('3', ''));
        for(var i = labels.length-1; i>= 0; i--)
        {
            // Check if the tab already exists
            if($('.tab-pane#' + labels[i].trim().toLowerCase() + ' .row').length == 0)
            {
                var tabName = labels[i].trim().toLowerCase();
                // Add the tab link
                var tab = tabHeader.replace('{{tablink}}', '#'+tabName).replace('{{tabname}}', tabName).replace('{{tabheading}}',labels[i].trim());
                $('ul.nav-tabs').append(tab);
                // Add the tab tab panel
                var tabContent = tabPanel.replace('{{tabname}}', tabName);
                $('div.tab-content').append(tabContent);
            }
            // get the labels and add the demo to the respective tabs
            $('.tab-pane#'+labels[i].trim().toLowerCase()+' .row').append(ele);
            if(labels[i].trim().toLowerCase() === 'development')
                development = true;
        }
        // Also add them to all and search tab
        if(!development)
        {
            $('.tab-pane#all .row').append(ele);
            $('.tab-pane#search .row').append(ele);
        }
    }

    function requestCode(demoName, id){
        $.ajax({
            url: 'gallery/' + demoName + '.html',
            handleAs: 'text',
        }).done(function(value){
            var code = value;
            var parser = new DOMParser();
            var doc = parser.parseFromString(code, 'text/html');
            var script = doc.querySelector('script[id="cesium_sandcastle_script"]');
            if (!script) {
                console.log('Error reading source file: ' + demoName);
                return;
            }
            var scriptMatch = scriptCodeRegex.exec(script.textContent);
            if (!scriptMatch) {
                console.log('Error reading source file: ' + demoName);
                return;
            }

            var scriptCode = scriptMatch[1];
            galleryList.push({name: demoName, code: scriptCode});
        }).fail(function(error){
            console.log(error);
        });
    }

    $('#searchBox').keyup(function() {
        $('#gallery-tabs a[href="#search"]').show();
        $('#gallery-tabs a[href="#search"]').tab('show');
        searchTerm = $('#searchBox').val();
        searchRegExp = new RegExp(searchTerm, 'i');
        var numDemosShown = 0;
        if (searchTerm !== '') {
            for (var i = 0; i < galleryList.length; i++) {
                var demo = galleryList[i];
                if(demo.name.indexOf("development") == -1)
                {
                    // Only add non development to search
                    var demoName = demo.name;
                    if (searchRegExp.test(demoName) || searchRegExp.test(demo.code)) {
                        $('.tab-pane#search #'+demoName.replace(/\s+/g,'').replace(/\)/g, '').replace(/\(/g,'').replace('3', '')).parent().show();
                        ++numDemosShown;
                    } else {
                        $('.tab-pane#search #'+demoName.replace(/\s+/g,'').replace(/\)/g, '').replace(/\(/g,'').replace('3', '')).parent().hide();
                    }
                }
            }
        } else {
            $('#gallery-tabs a[href="#search"]').hide();
            $('#gallery-tabs a[href="#all"]').tab('show');
        }
        if (numDemosShown) {
            $('.error-msg').hide();
        } else {
            $('.error-msg').show();
        }
    });
</script>
</body>
</html>
